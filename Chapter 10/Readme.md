# The Conclusion

This is the last chapter of this SQL tutorial series, in this chapter we will discuss about SQL Views and Stored Procedure and see some miscellaneous topics and best practices.

Topics:
- SQL View
- Stored Procedure
- Miscellaneous
	- Choosing Default Database
	- Changing Delimiter
	- SQL Best Practices
	- Resources to Practice SQL



## SQL Views

A view is a virtual table based on the result-set of an SQL statement. It contains rows and columns, just like a real table. The fields in a view are fields from one or more real tables in the database.

It is operated similarly to the base table but does not contain any data of its own. The View and table have one main difference that the views are definitions built on top of other tables (or views). If any changes occur in the underlying table, the same changes reflected in the View also.

We can create a new view by using the CREATE VIEW and SELECT statement. SELECT statements are used to take data from the source table to make a VIEW.

**Syntax:**

```sql
CREATE [OR REPLACE] VIEW view_name AS    
SELECT columns    
FROM tables    
[WHERE conditions];  
```

**Example:** Let's create a view which contains customers complete details using the data we have in Sakila DB(i.e. customer_id, name, address, zip code, city, country, phone, email and status whether active or not).

To achieve this we will need to use below tables from sakila db to get corresponding fields:

- customer: customer_id, first_name, last_name, email, active
- address: address, postal_code, phone
- city: city
- country: country

```sql
CREATE OR REPLACE VIEW customer_details_vw AS 
	SELECT cu.customer_id AS ID,
		CONCAT(cu.first_name,' ',cu.last_name) AS 'customer name',
		a.address AS address,
		a.postal_code AS 'zip code',
		ci.city AS city,
		co.country AS country,
		a.phone AS phone,
		cu.email AS email,
		IF(cu.active,'active','') AS status
	FROM customer cu 
	JOIN address a ON cu.address_id = a.address_id
	JOIN city ci ON a.city_id = ci.city_id
	JOIN country co ON ci.country_id = co.country_id;
```
<br>

**Benefits of using Views**
- Simplify complex business logics: view helps to simplify the complex business logic written in the SQL queries. Instead of executing the same complex query multiple times, you can create a view from it. This View can be referenced by using a simple SELECT query.
- Improves data security: We can use views to display user-specific contents, this improves the security as user can be restricted from using source table with lot many information which may not be relevant.
- Reduce data distraction: Views do not show the irrelevant column hence they reduce data distraction.
- Preserves the appearance of original table structure: A view can preserve the appearance of the original table structure to minimize disruption to other applications.

<br>

## Stored Procedure

A Stored Procedure is a collection of pre-compiled SQL statements stored inside the database. It is a subroutine or a subprogram in the regular computing language. A stored procedure has a name, a parameter list, and SQL statement(s).

The stored procedure is defined by wraping a SQL statements within the CREATE PROCEDURE statement. The stored procedure may contain a conditional statement like IF or CASE or the Loops. The stored procedure can also execute another stored procedure or a function that modularizes the code.

In MySQL, stored procedure execution is called "calling", and so the statement to execute a stored procedure is simply ***CALL***. CALL takes the name of the stored procedure and any parameters that need to be passed on to it. 

**Syntax:** _CREATE PROCEDURE_
```
CREATE PROCEDURE procedure_name ([parameter_1], [parameter_2], [parameter_3],.. )
BEGIN
SQL Queries..
END
```

In the syntax above:
1. The name of the procedure must be specified after the CREATE PROCEDURE keyword
2. After the name of the procedure, the list of parameters should be specified in the parenthesis. The parameter list must be comma-separated
3. The SQL Queries and code must be written between BEGIN and END keywords

**Syntax:** _CALL PROCEDURE_
```
CALL procedure_name(@parameter1, @parameter2);
```

In the syntax above:
1. The name of the procedure must be specified after the CALL keyword
2. After the name of the procedure, the list of parameters should be specified in the parenthesis. The parameter list must be prefixed with @ and should be comma-separated.

### Stored procedure Parameters
The MySQL Stored procedure parameter has three modes: IN, OUT, and INOUT. 

- IN: When we declare an IN type parameter, the application must pass an argument to the stored procedure. It is a default mode.
- OUT: The OUT type parameter, the stored procedure returns a final output generated by SQL Statements.
- INOUT: When we declare the INOUT type parameter, the application has to pass an argument, and based on the input argument; the procedure returns the output to the application.

**Syntax:** _PARAMETERS_
```
([IN/OUT/INOUT] parameter1 [datatype(length)], [IN/OUT/INOUT] parameter2 [datatype(length)],..)
```

In the syntax above:
1. Specify the type of the parameter. It can be IN, OUT or INOUT
2. Specify the name and data type of the parameter

<br>

**Example 1:**

Let's create a stored procedure, which will take film_id as input and will return all the details related to the film. In this example let's try to get the details of film with film_id '9'.

_1. Create Procedure:_

```sql
DELIMITER //

CREATE PROCEDURE sp_GetMovies(IN sp_film_id int)
BEGIN
    SELECT *
    FROM sakila.film
    WHERE film_id=sp_film_id;
END //

DELIMITER ;
```


_2. Call Procedure:_

```sql
CALL sp_GetMovies(9);
```

**Output:**

![image](https://user-images.githubusercontent.com/67796162/164969629-8aa99af0-17ac-455a-8f98-2dd963be5cb3.png)

<br>

**Example 2:**
 Create a stored procedure which returns the name of the film along with no of actors in it when film_id is passed on to it.
 
_1. Create Procedure:_
 
 ```sql
 CREATE PROCEDURE sp_ActorCount(IN sp_film_id int, OUT sp_count int)
BEGIN
	SELECT ft.title as "Film",
    COUNT(fa.actor_id) "No of Actors"
	FROM sakila.film_actor fa
    LEFT JOIN sakila.film_text ft ON fa.film_id=ft.film_id
	WHERE fa.film_id=sp_film_id;
END //

DELIMITER ;
 ```

_2. Call Procedure:_

```sql
CALL sp_ActorCount(9, @sp_count);
```

**Output:**

![image](https://user-images.githubusercontent.com/67796162/164969700-93f2a336-8b67-4ea0-9e12-5300dd51afdf.png)

<br>

Below are some benefits of Stored Procedure:
- **Reduce the Network Traffic:** Multiple SQL Statements are encapsulated in a stored procedure. When you execute it, instead of sending multiple queries, we are sending only the name and the parameters of the stored procedure
- **Easy to maintain:** The stored procedure are reusable. We can implement the business logic within an SP, and it can be used by applications multiple times, or different modules of an application can use the same procedure. This way, a stored procedure makes the database more consistent. If any change is required, you need to make a change in the stored procedure only
- **Secure:** The stored procedures are more secure than the AdHoc queries. The permission can be granted to the user to execute the stored procedure without giving permission to the tables used in the stored procedure. The stored procedure helps to prevent the database from SQL Injection

<br>

<br>


## Miscellaneous

### Choosing Default Database

There are two options to choose the default database before performing any SQL operation:
1. Right click on database and click on "Set as Default Schema"
2. ***USE***: USE keyword along with database name can be used to set the default database before any SQL statements run. Below is the syntax to use it:

**Syntax:**

```sql
USE database_name;
```

**Example:**

```sql
USE sakila;

SELECT * FROM film_text;
```

<br>

### Changing Delimiter

The default delimiter in almost all of the SQL flavours including MySQL is semicolon(;). Although this can be changed to another character e.g., // or $$.

There are few cases where changing delimeter is required specially in Stored Procedures which consists of multiple statements separated by a semicolon (;). If you use a MySQL client program(MySQL Workbench) to define a stored procedure that contains semicolon characters, MySQL Workbench will not treat the whole stored procedure as a single statement, but many statements.

Therefore, you must redefine the delimiter temporarily so that you can pass the whole stored procedure to the server as a single statement.

The delimiter_character may consist of a single character or multiple characters e.g., // or $$. However, you should avoid using the backslash (\) because it’s the escape character in MySQL.

**Syntax:**
```sql
DELIMITER delimiter_character
```

**Example:**
```sql
DELIMITER //
```

<br>

### SQL Best Practices

Since you will be using SQL for you data analysis purposes and will write lot many queries, which will be acessible to many people around your organization, So its better to follow some SQL best practices. Following best practices will help manage the code efficiently and share it among other team members.

Below are some of the SQL best pracices I have listed down:
1. **Comment The Code:** Use proper commenting within code to make sure someone else can easily understand it, although don't overdo it.
2. **Format The Code:** Format your code so that its is redable. Use proper Indentation & White spaces to seperate subqueries from outerquery.
3. **Uppercase for SQL Keywords:** Use uppercase for the SQL keywords and Functions, and lowercase for your tables and columns.
4. **Snake Case for Naming:** Snake Case also referred to as underscore case should be used whenever naming any object like Database, Schema, Table or Column.
5. **Alias The Tables:** Use aliases to rename tables or columns which doesn’t make sense specially when joining multiple tables, it's good practice to give an alias to each of the tables.
6. **Meaningful Naming:** Use a meaningful naming convention and follow same throughout your code. If required you should define your own convention and have it adopted by your team.
7. **Order of Execution:** Before you start writing your query, frame the question to understand which one is the primary table and hence start joining other tables to it and always filter out unnecessary data by using where condition.
8. **Follow ANSI-92 JOIN Syntax:** Instead of using SQL WHERE Clause for Joining Tables start using proper Join Syntax with ON condition to join tables.
9. **Avoid SELECT \*:** Whenever possible avoid using select '\*', instead use specific column name for which the data is required.
10. **Split into Multiple Queries:** Sometimes the SQL statement can be really long and it becomes complicated to read or relate each part of the query. So whenever possible split the code into multiple queries using Temporary Table or CTEs. A CTE or Temporary table not only improves redability but also improves usability, so strat using CTEs.




